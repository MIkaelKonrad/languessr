<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Guess evaluation</title>


    <!-- Importing FirstButton.css for button style -->
    <link rel="stylesheet" type="text/css"  href="/static/css/FirstButton.css">


    <!-- css code for map style  -->
    <style> 
    #map {
      height: 80%;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }	
    </style>
   

</head>


<body >


  <!-- Defining div element for map -->
  <div id="map"></div>


  <!-- Js code which displays a marker both for the sulotion and for the guess made -->
  <!-- The Js code below is too large to be kept inside this html file however outsourcing it to its own file doesn't work.-->
  <script> 
    let map;
    let markersArray=[] ; 
    var abc = false;
    var guessLat = parseFloat(localStorage.getItem("GuessLat"));
    var guessLng = parseFloat(localStorage.getItem("GuessLng"));
    var targetLat = parseFloat(localStorage.getItem("targetLat"));
    var targetLng = parseFloat(localStorage.getItem("targetLng")); 
    function initMap() {
     /*The If else statement below computes the degree 'Zoomedinness' the map as depending on the accuracy of the guess made
     at the moment there are only three levels of 'Zoomedinness' developping a comtinuous funtion accuracyGuess -> Zoom, is still to do  */
     if (parseFloat(localStorage.getItem('accuracyGuess'))>5000){
        var Zoom =2.3;
      } else if (5000>parseFloat(localStorage.getItem('accuracyGuess'))>1000){
         var Zoom=3
      }else {
         var Zoom=6
      };

      /* Below we create a new instance of the google.maps.Map class centerd at the half way point between guess and solution */
      map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: (guessLat + targetLat)/2, lng: (guessLng+targetLng)/2 },
          zoom: Zoom
        });
      
      /* below we create a new instance of the google.maps.Polyline class this element is visible as geodesic line 
      connecting guess location and solution location. 
      Possibly a non-Geodesic would look better i.e. a line which is straight on the but curved in irl as opposed to line that is straight 
          irl but appears curved on the map.*/
      var connectingLine = new google.maps.Polyline({
          path: [ {lat: guessLat , lng: guessLng}, {lat: targetLat , lng: targetLng} ],
          geodesic: true,
          strokeColor: "#000000",
          strokeOpacity: 1.0,
          strokeWeight: 1.5,
        })
      connectingLine.setMap(map); // displaying the Polyline defined above on the map

        /* The blow objects: 
              GuessFLagIcon: Style of the flag used to indicate the guess of the user
              flagIcon: Style of the flag used to indicate the solution
              markerGuess: Instance of google.maps.Marker class appearing where user made a guess
              markerTarget: Instance of google.maps.Marker class appearing at the location of the solution.
        */
        const GuessFlagIcon = {
          url: '/static/images/GuessFlag_Layer 1.png', // url
          scaledSize: new google.maps.Size(30, 60), // scaled size
          origin: new google.maps.Point(0,0), // origin
          anchor: new google.maps.Point(0, 60) // anchor
        };

        const flagIcon = {
          url: '/static/images/flag_Layer 1.png', // url
          scaledSize: new google.maps.Size(30, 60), // scaled size
          origin: new google.maps.Point(0,0), // origin
          anchor: new google.maps.Point(0, 60) // anchor
        };

        var markerGuess = new google.maps.Marker({
          map: map,
          position: {lat: guessLat , lng: guessLng},
          draggable: true,
          icon: GuessFlagIcon
        });

        var markerTarget = new google.maps.Marker({
          map: map,
          position: {lat: targetLat , lng: targetLng},
          draggable: true,
          icon: flagIcon
        });
    }

  </script>
  
  
  <!-- The Js Code below computes the number of points achieved by the player as well as 
    displaying those points and the distance between guess location and solution location -->
  <script>

    if (parseFloat(localStorage.getItem('accuracyGuess'))>1) {
          window.onload = function() {
              document.getElementById('welcome').innerText = "Your Guess was off by " + Math.round(parseFloat(localStorage.getItem('accuracyGuess'))) + " km, which gives you a score of " 
              + Math.round(5000*(((15000-parseFloat(localStorage.getItem('accuracyGuess')))/15000)**6))+ '.';
            };
        } else{ 
          window.onload = function() {
              document.getElementById('welcome').innerText = "Your Guess was off by " + Math.round(parseFloat(localStorage.getItem('accuracyGuess'))*1000) + " m, which gives you a score of 5000.";
            }
        }
  </script>


  <!-- The Js Code below accesses the GoogleMaps API-->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAx9c3TZDsF8PKs6jC5lf1ZlG-MN8iHthE&callback=initMap">
  </script>


  <!-- The code Below creates buttons as attributes. -->
	<a href="\">
		<button class=first-button>
		  Try Again
	  </button>
	</a>
	<a href="\Start">
    <button class=big-button> Back to Start </button>
  </a>

  <!-- The code below updates the round counding -->
  <script>
  /* If no round count or roundcount = 5 set roundnuber to 1, else increase roundcount by one*/
  if(localStorage.getItem('roundNumber')==null) {
      localStorage.setItem('roundNumber', 1)
    }else if(parseInt(localStorage.getItem('roundNumber')) < 5 ){
      localStorage.setItem('roundNumber',parseFloat(localStorage.getItem('roundNumber')) +1);
    }else{
      localStorage.setItem('roundNumber',1);
    } 
  </script>


  <!-- The code below displays number of points and distance to solution on the page. -->
  <h1 id="welcome"> </h1>
</body>
</html>